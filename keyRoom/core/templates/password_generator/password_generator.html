{% extends 'base.html' %}
{% block title %}Gerador de Senhas - KeyRoom{% endblock %}

{% block content %}
<div class="container-fluid py-4">

    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-dismissible fade show
        {% if 'danger' in message.tags %}
            bg-danger text-light
        {% elif 'success' in message.tags %}
            bg-success text-light
        {% elif 'warning' in message.tags %}
            bg-warning text-dark
        {% else %}
            bg-dark text-light
        {% endif %}
        border-secondary" role="alert">
                {{ message }}
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="alert"
                        aria-label="Fechar"></button>
            </div>
        {% endfor %}
    {% endif %}

    <div class="row justify-content-center">
        <div class="col-lg-7 col-md-10">
            <div class="card bg-dark text-light border-secondary shadow-sm p-4">
                <h4 class="card-title mb-4 text-center">Gerador de Senhas üîí</h4>

                <div class="mb-3">
                    <label class="form-label text-secondary">Senha Gerada</label>
                    <div class="input-group">
                        <input type="text"
                               class="form-control bg-dark text-light border-secondary fs-5"
                               id="passwordResult"
                               placeholder="Clique em 'Gerar' para criar sua senha"
                               readonly>
                        <button class="btn btn-outline-secondary" id="copyButton" onclick="copyPassword()">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                </div>

                <form id="generatorForm" class="mt-3">
                    <div class="mb-4">
                        <label for="lengthSlider" class="form-label">
                            Comprimento: <span id="lengthValue" class="fw-bold text-light">20</span>
                        </label>
                        <input type="range" class="form-range" id="lengthSlider" name="comprimento"
                               min="5" max="128" value="20">
                    </div>

                    <div class="mb-4">
                        <label class="form-label text-secondary">Incluir Caracteres</label>
                        <div class="row">
                            <div class="col-sm-6">
                                <div class="form-check form-switch mb-2">
                                    <input class="form-check-input" type="checkbox" id="checkUpper"
                                           name="usar_maiusculas" checked>
                                    <label class="form-check-label" for="checkUpper">Mai√∫sculas (A-Z)</label>
                                </div>
                                <div class="form-check form-switch mb-2">
                                    <input class="form-check-input" type="checkbox" id="checkLower"
                                           name="usar_minusculas" checked>
                                    <label class="form-check-label" for="checkLower">Min√∫sculas (a-z)</label>
                                </div>
                            </div>
                            <div class="col-sm-6">
                                <div class="form-check form-switch mb-2">
                                    <input class="form-check-input" type="checkbox" id="checkNumbers"
                                           name="usar_numeros" checked>
                                    <label class="form-check-label" for="checkNumbers">N√∫meros (0-9)</label>
                                </div>
                                <div class="form-check form-switch mb-2">
                                    <input class="form-check-input" type="checkbox" id="checkSpecial"
                                           name="usar_especiais" checked>
                                    <label class="form-check-label" for="checkSpecial">Especiais (!@#$...)</label>
                                </div>
                            </div>
                        </div>
                        <div id="checkboxError" class="text-danger mt-2" style="display: none;">
                            <small>Pelo menos uma op√ß√£o de caractere deve ser selecionada.</small>
                        </div>
                    </div>

                    <button type="button" id="generateButton" class="btn btn-success w-100 btn-lg mt-3">
                        <i class="fas fa-sync"></i> Gerar Senha
                    </button>
                </form>

            </div>
        </div>
    </div>

    <div id="appToast" class="toast align-items-center text-bg-dark border-0 position-fixed bottom-0 end-0 m-3"
         role="alert">
        <div class="d-flex">
            <div class="toast-body">Mensagem padr√£o</div>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const lengthSlider = document.getElementById('lengthSlider');
        const lengthValue = document.getElementById('lengthValue');
        const generateButton = document.getElementById('generateButton');
        const resultInput = document.getElementById('passwordResult');
        const checkboxError = document.getElementById('checkboxError');

        const checkboxes = [
            document.getElementById('checkUpper'),
            document.getElementById('checkLower'),
            document.getElementById('checkNumbers'),
            document.getElementById('checkSpecial')
        ];


        let debounceTimer;




        function debounce(func, delay) {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(func, delay);
        }

        function validateCheckboxes() {
            const atLeastOneChecked = checkboxes.some(cb => cb.checked);
            if (atLeastOneChecked) {
                generateButton.disabled = false;
                checkboxError.style.display = 'none';
            } else {
                // Se nenhum for marcado, desabilita o bot√£o e limpa o campo
                generateButton.disabled = true;
                checkboxError.style.display = 'block';
            }
            return atLeastOneChecked;
        }

        async function fetchPassword() {
            if (!validateCheckboxes() || generateButton.disabled) return;

            const length = lengthSlider.value;
            const upper = document.getElementById('checkUpper').checked;
            const lower = document.getElementById('checkLower').checked;
            const numbers = document.getElementById('checkNumbers').checked;
            const special = document.getElementById('checkSpecial').checked;


            resultInput.value = "Gerando...";
            generateButton.disabled = true;
            generateButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Gerando...';


            const params = new URLSearchParams();
            params.append('length', length);
            params.append('uppercase', upper);
            params.append('lowercase', lower);
            params.append('numbers', numbers);
            params.append('special_characters', special);

            const url = `{% url 'generate_password' %}?${params.toString()}`;

            try {
                const response = await fetch(url);
                const data = await response.json();

                if (response.ok && data.password) {
                    resultInput.value = data.password;
                } else {
                    resultInput.value = "";
                    showToast(data.error || "Erro ao gerar a senha.", "danger");
                }

            } catch (error) {
                console.error("Erro no fetch:", error);
                resultInput.value = "";
                showToast("Erro de conex√£o com o servidor.", "danger");
            } finally {
                // Restaura o bot√£o
                generateButton.innerHTML = '<i class="fas fa-sync"></i> Gerar Senha';
                validateCheckboxes(); // Re-valida para re-habilitar o bot√£o se for o caso
            }
        }

        // Copia a senha para o clipboard (mantido como estava)
        window.copyPassword = function () {
            const text = resultInput.value;
            const button = document.getElementById('copyButton');

            if (!text || text === "Gerando...") {
                showToast("Nenhuma senha para copiar.", "warning");
                return;
            }

            navigator.clipboard.writeText(text).then(() => {
                button.innerHTML = '<i class="fas fa-check text-success"></i>';
                showToast("Senha copiada!", "success");
                setTimeout(() => {
                    button.innerHTML = '<i class="fas fa-copy"></i>';
                }, 2000);
            }).catch(err => {
                showToast("Falha ao copiar.", "danger");
                console.error("Falha ao copiar:", err);
            });
        }

        // Fun√ß√£o de Toast
        window.showToast = function (message, type = "dark") {
            const toastEl = document.getElementById("appToast");
            const body = toastEl.querySelector(".toast-body");

            body.textContent = message;
            toastEl.className = `toast align-items-center text-bg-${type} border-0 position-fixed bottom-0 end-0 m-3`;

            const toast = new bootstrap.Toast(toastEl);
            toast.show();
        }


        //Atualiza o valor do span e DEBOUNCE para chamar a gera√ß√£o de senha
        lengthSlider.addEventListener('input', () => {
            lengthValue.textContent = lengthSlider.value;
            debounce(fetchPassword, 300); // 300ms de atraso ap√≥s o movimento
        });

        //Chamar a gera√ß√£o de senha imediatamente ao clicar no bot√£o "Gerar"
        generateButton.addEventListener('click', fetchPassword);

        //Chamar a gera√ß√£o de senha imediatamente ao MUDAR o estado dos checkboxes
        checkboxes.forEach(cb => {
            cb.addEventListener('change', () => {
                validateCheckboxes();
                fetchPassword();
            });
        });

        //Gera√ß√£o inicial da senha ao carregar a p√°gina
        fetchPassword();
    });
</script>
{% endblock %}